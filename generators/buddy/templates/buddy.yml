- pipeline: "Staging"
  trigger_mode: "ON_EVERY_PUSH"
  ref_name: "master"
  ref_type: "BRANCH"
  target_site_url: "http://<%= projectName %>-staging.malven.co"
  trigger_condition: "ALWAYS"
  actions:
  - action: "Execute: build"
    type: "BUILD"
    working_directory: "/buddy/<%= projectName %>"
    docker_image_name: "library/node"
    docker_image_tag: "10.8.0"
    execute_commands:
    - "# CMDs working directory is the pipeline's filesystem with cloned repo "
    - "yarn"
    - "NODE_ENV=production yarn build"
    - ""
    setup_commands:
    - "# Executed on the first pipeline execution only"
    - "# Popular use case: install packages required by your Run Commands"
    - "# Changing the image in the Environment tab will run the commands again"
    - "npm install -g gulp"
    - ""
    mount_filesystem_path: "/buddy/<%= projectName %>"
    shell: "SH"
    trigger_condition: "ALWAYS"
  - action: "Execute: composer install"
    type: "BUILD"
    working_directory: "/buddy/<%= projectName %>"
    docker_image_name: "library/php"
    docker_image_tag: "7.3.5"
    execute_commands:
    - "# CMDs working directory is the pipeline's filesystem with cloned repo "
    - "composer install"
    - ""
    setup_commands:
    - "# Executed on the first pipeline execution only"
    - "# Popular use case: install packages required by your Run Commands"
    - "# Changing the image in the Environment tab will run the commands again"
    - "apt-get update && apt-get install -y openssl zlib1g-dev libzip-dev"
    - "curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer"
    - "docker-php-ext-install zip"
    - "apt-get update && apt-get install git -y"
    - ""
    mount_filesystem_path: "/buddy/<%= projectName %>"
    shell: "SH"
    trigger_condition: "ALWAYS"
  - action: "Rsync Files"
    type: "RSYNC"
    local_path: "/"
    remote_path: "${server_path}"
    login: "${server_user}"
    host: "${server_host}"
    port: "22"
    env_key: "secure!uhJC5TiOOBBs101zu87x3g=="
    authentication_mode: "ENV_KEY"
    archive: true
    delete_extra_files: true
    recursive: true
    compress: true
    deployment_excludes:
    - ".browserslistrc"
    - ".dockerignore"
    - ".editorconfig"
    - ".env*"
    - ".eslintrc"
    - ".git"
    - ".gitignore"
    - ".nvmrc"
    - ".stylelintrc"
    - "/.cache/"
    - "/.composer/"
    - "/.config/"
    - "/.local/"
    - "/.npm/"
    - "/bower_components/"
    - "/docker/"
    - "/gulp/"
    - "/log/"
    - "/node_modules/"
    - "/resources/"
    - "/src/"
    - "/storage/"
    - "/tmp/"
    - "auth.json"
    - "bower.json"
    - "composer.json"
    - "composer.lock"
    - "docker-compose.yml"
    - "Dockerfile"
    - "env.sample"
    - "gulpfile.js"
    - "package.json"
    - "public"
    - "README.md"
    - ".stylelintrc"
    - "yarn.lock"
    trigger_condition: "ALWAYS"
  - action: "Craft: Clear Cache and Migrations"
    type: "SSH_COMMAND"
    working_directory: "${server_path}"
    login: "${server_user}"
    host: "${server_host}"
    port: "22"
    env_key: "secure!uhJC5TiOOBBs101zu87x3g=="
    authentication_mode: "ENV_KEY"
    commands:
    - "./craft blitz/cache/refresh"
    - "./craft migrate/all"
    run_as_script: true
    shell: "BASH"
    trigger_condition: "ALWAYS"
  - action: "Send notification to Pushover"
    type: "PUSHOVER"
    title: "Buddy - <%= projectTitle %> Staging"
    content: "${execution.pipeline.name} execution #${execution.id}"
    link: "${execution.html_url}"
    link_title: "Show execution details"
    device: "desktop-imac"
    priority: "HIGH"
    trigger_condition: "ALWAYS"
    integration_id: 20934
  - action: "Send notification to slack channel"
    type: "SLACK"
    trigger_time: "ON_FAILURE"
    content: "[#${execution.id}] ${execution.pipeline.name} execution by <${invoker.html_url}|${invoker.name}>"
    channel: "D4BAU65FF"
    attachments:
    - "{\"fallback\":\"${execution.pipeline.name} execution #${execution.id}\",\"color\":\"danger\",\"fields\":[{\"title\":\"Failed execution\",\"value\":\"<${execution.html_url}|Execution #${execution.id} ${execution.comment}>\",\"short\":true},{\"title\":\"Pipeline\",\"value\":\"<${execution.pipeline.html_url}|${execution.pipeline.name}>\",\"short\":true},{\"title\":\"Branch\",\"value\":\"${execution.branch.name}\",\"short\":true},{\"title\":\"Project\",\"value\":\"<${project.html_url}|${project.name}>\",\"short\":true}]}"
    trigger_condition: "ALWAYS"
    integration_id: 10282
  - action: "Send notification to slack channel"
    type: "SLACK"
    trigger_time: "ON_BACK_TO_SUCCESS"
    content: "[#${execution.id}] ${execution.pipeline.name} execution by <${invoker.html_url}|${invoker.name}>"
    channel: "D4BAU65FF"
    attachments:
    - "{\"fallback\":\"${execution.pipeline.name} execution #${execution.id}\",\"color\":\"good\",\"fields\":[{\"title\":\"Successful execution\",\"value\":\"<${execution.html_url}|Execution #${execution.id} ${execution.comment}>\",\"short\":true},{\"title\":\"Pipeline\",\"value\":\"<${execution.pipeline.html_url}|${execution.pipeline.name}>\",\"short\":true},{\"title\":\"Branch\",\"value\":\"${execution.branch.name}\",\"short\":true},{\"title\":\"Project\",\"value\":\"<${project.html_url}|${project.name}>\",\"short\":true}]}"
    trigger_condition: "ALWAYS"
    integration_id: 10282
  variables:
  - key: "server_host"
    value: "104.236.66.159"
    id: 153177
    settable: true
    description: ""
  - key: "server_path"
    value: "/srv/users/serverpilot/apps/<%= projectName %>"
    id: 153178
    settable: true
    description: ""
  - key: "server_user"
    value: "serverpilot"
    id: 153179
    settable: true
    description: ""
- pipeline: "Production"
  trigger_mode: "MANUAL"
  ref_name: "master"
  ref_type: "BRANCH"
  target_site_url: "https://<%= projectName %>.com"
  trigger_condition: "ALWAYS"
  actions:
  - action: "Execute: build"
    type: "BUILD"
    working_directory: "/buddy/<%= projectName %>"
    docker_image_name: "library/node"
    docker_image_tag: "10.13.0"
    execute_commands:
    - "# CMDs working directory is the pipeline's filesystem with cloned repo "
    - "yarn"
    - "NODE_ENV=production yarn build"
    - ""
    setup_commands:
    - "# Executed on the first pipeline execution only"
    - "# Popular use case: install packages required by your Run Commands"
    - "# Changing the image in the Environment tab will run the commands again"
    - "npm install -g gulp"
    - ""
    mount_filesystem_path: "/buddy/<%= projectName %>"
    shell: "SH"
    trigger_condition: "ALWAYS"
  - action: "Execute: composer install"
    type: "BUILD"
    working_directory: "/buddy/<%= projectName %>"
    docker_image_name: "library/php"
    docker_image_tag: "7.3.5"
    execute_commands:
    - "# CMDs working directory is the pipeline's filesystem with cloned repo "
    - "composer install"
    - ""
    setup_commands:
    - "# Executed on the first pipeline execution only"
    - "# Popular use case: install packages required by your Run Commands"
    - "# Changing the image in the Environment tab will run the commands again"
    - "apt-get update && apt-get install -y openssl zlib1g-dev libzip-dev"
    - "curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer"
    - "docker-php-ext-install zip"
    - "apt-get update && apt-get install git -y"
    - ""
    mount_filesystem_path: "/buddy/<%= projectName %>"
    shell: "SH"
    trigger_condition: "ALWAYS"
  - action: "Rsync Files"
    type: "RSYNC"
    local_path: "/"
    remote_path: "${server_path}"
    login: "${server_user}"
    host: "${server_host}"
    port: "22"
    env_key: "secure!uhJC5TiOOBBs101zu87x3g=="
    authentication_mode: "ENV_KEY"
    archive: true
    delete_extra_files: true
    recursive: true
    compress: true
    deployment_excludes:
    - ".browserslistrc"
    - ".dockerignore"
    - ".editorconfig"
    - ".env*"
    - ".eslintrc"
    - ".git"
    - ".gitignore"
    - ".nvmrc"
    - ".stylelintrc"
    - "/.cache/"
    - "/.composer/"
    - "/.config/"
    - "/.local/"
    - "/.npm/"
    - "/bower_components/"
    - "/docker/"
    - "/gulp/"
    - "/log/"
    - "/node_modules/"
    - "/resources/"
    - "/src/"
    - "/storage/"
    - "/tmp/"
    - "auth.json"
    - "bower.json"
    - "composer.json"
    - "composer.lock"
    - "docker-compose.yml"
    - "Dockerfile"
    - "env.sample"
    - "gulpfile.js"
    - "package.json"
    - "public"
    - "README.md"
    - ".stylelintrc"
    - "yarn.lock"
    trigger_condition: "ALWAYS"
  - action: "Craft: Clear Cache and Migrations"
    type: "SSH_COMMAND"
    working_directory: "${server_path}"
    login: "${server_user}"
    host: "${server_host}"
    port: "22"
    env_key: "secure!uhJC5TiOOBBs101zu87x3g=="
    authentication_mode: "ENV_KEY"
    commands:
    - "./craft blitz/cache/refresh"
    - "./craft migrate/all"
    run_as_script: true
    shell: "BASH"
    trigger_condition: "ALWAYS"
  - action: "Send notification to Pushover"
    type: "PUSHOVER"
    title: "Buddy - <%= projectTitle %> Production"
    content: "${execution.pipeline.name} execution #${execution.id}"
    link: "${execution.html_url}"
    link_title: "Show execution details"
    device: "desktop-imac"
    priority: "HIGH"
    trigger_condition: "ALWAYS"
    integration_id: 20934
  - action: "Send notification to slack channel"
    type: "SLACK"
    trigger_time: "ON_FAILURE"
    content: "[#${execution.id}] ${execution.pipeline.name} execution by <${invoker.html_url}|${invoker.name}>"
    channel: "D4BAU65FF"
    attachments:
    - "{\"fallback\":\"${execution.pipeline.name} execution #${execution.id}\",\"color\":\"danger\",\"fields\":[{\"title\":\"Failed execution\",\"value\":\"<${execution.html_url}|Execution #${execution.id} ${execution.comment}>\",\"short\":true},{\"title\":\"Pipeline\",\"value\":\"<${execution.pipeline.html_url}|${execution.pipeline.name}>\",\"short\":true},{\"title\":\"Branch\",\"value\":\"${execution.branch.name}\",\"short\":true},{\"title\":\"Project\",\"value\":\"<${project.html_url}|${project.name}>\",\"short\":true}]}"
    trigger_condition: "ALWAYS"
    integration_id: 10282
  - action: "Send notification to slack channel"
    type: "SLACK"
    trigger_time: "ON_BACK_TO_SUCCESS"
    content: "[#${execution.id}] ${execution.pipeline.name} execution by <${invoker.html_url}|${invoker.name}>"
    channel: "D4BAU65FF"
    attachments:
    - "{\"fallback\":\"${execution.pipeline.name} execution #${execution.id}\",\"color\":\"good\",\"fields\":[{\"title\":\"Successful execution\",\"value\":\"<${execution.html_url}|Execution #${execution.id} ${execution.comment}>\",\"short\":true},{\"title\":\"Pipeline\",\"value\":\"<${execution.pipeline.html_url}|${execution.pipeline.name}>\",\"short\":true},{\"title\":\"Branch\",\"value\":\"${execution.branch.name}\",\"short\":true},{\"title\":\"Project\",\"value\":\"<${project.html_url}|${project.name}>\",\"short\":true}]}"
    trigger_condition: "ALWAYS"
    integration_id: 10282
  variables:
  - key: "server_host"
    value: "XXX.XXX.XXX.XX"
    id: 160711
    settable: true
    description: ""
  - key: "server_path"
    value: "/storage/avXXXXX/www/public_html"
    id: 160712
    settable: true
    description: ""
  - key: "server_user"
    value: "avXXXXX"
    id: 160713
    settable: true
    description: ""
